<?php
include_once 'config.php';
$GLOBALS['tagI'] = 0;
function sendCommand($sock, $cmd)
{
	$tag = 'FU' . ++$GLOBALS['tagI'];
	$command = $tag . ' ' . $cmd . "\r\n";
	//print $command;
	fwrite($sock, $command);
	
	$result = '';
	while ($line = fgets($sock)) {
		$result .= $line;
		$line = preg_split('/\s+/', $line, 0, PREG_SPLIT_NO_EMPTY);
		$code = $line[0];
		if (strtoupper($code) == $tag) {
			break;
		}
	}
	return $result;
}

if($_SERVER['REQUEST_METHOD'] == 'POST')
{
	header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
	header("Expires: Sat, 26 Jul 1997 05:00:00 GMT"); // Date in the past
	header('Content-Type: text/plain');

	// split user field by the last occurring '@' symbol
	$paths = explode('#', $_POST['path']);
	$user = $paths[0];
	$account_split = strrpos($user, '@');
	if($account_split === false)
	{
		header('HTTP/1.1 500 Could not read account information');
		exit; // display error and exit
	}
	
	$user_host = array(substr($user, 0, $account_split),
		substr($user, $account_split + 1, strlen($user) - $account_split - 1));
	$host_port = explode(':', $user_host[1]);
	
	// validate the username, except allow an email address
	if(!preg_match('/[a-z0-9!#$%&\'*+\/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&\'*+\/=?^_`{|}~-]+)*(@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?)*/i', $user_host[0]))
	{
		header('HTTP/1.1 500 Invalid account username');
		exit; // display error and exit
	}
	
	// validate the host and port
	if(!preg_match('/^(?P<host>[a-z0-9\-._~%]+|\[[a-f0-9:.]+\]|\[v[a-f0-9][a-z0-9\-._~%!$&\'()*+,;=:]+\])(:(?P<port>[0-9]+))?$/', $user_host[1]))
	{
		header('HTTP/1.1 500 Invalid host');
		exit; // display error and exit
	}
	
	// perform first connection attempt
	$sock = fsockopen('ssl://' . $host_port[0], count($host_port) > 1 ? $host_port[1] : '993', $errno, $errstr, 1);
	if (!$sock)
	{
		// TODO: try a different port
		$sock = fsockopen('ssl://' . 'imap.' . $host_port[0], (count($host_port) > 1 ? $host_port[1] : '993'), $errno, $errstr, 1);
		if (!$sock)
		{
			header('HTTP/1.1 500 Could not connect to host');
			exit; // display error and exit
		}
	}
	$welcome = fgets($sock);
	
	// authenticate
	$auth = sendCommand($sock, 'LOGIN "' . addslashes($user_host[0]) . '" "' . addslashes(base64_decode($_POST['access'])) . '"');
	// check for failure
	if(strpos($auth, ' NO ') || strpos($auth, ' BAD '))
	{
		// try full e-mail as usename
		$auth = sendCommand($sock, 'LOGIN "' . addslashes($user) . '" "' . addslashes(base64_decode($_POST['access'])) . '"');
		if(strpos($auth, ' NO ') || strpos($auth, ' BAD '))
		{
			header('HTTP/1.1 401 Login failed');
			exit; // display error and exit
		
		}
	}

	// last step before exiting
	print json_encode(array(
		'welcome' => $welcome,
		'connect' => $connect,
		'user' => $user_host[0],
		'host' => $host_port[0]), JSON_PRETTY_PRINT);
		
	ob_end_flush();
	flush();
	exit;

}

?>
<div class="dialog" id="login">
<h1>Sign in</h1>
<table class="fancy">
<thead>
<tr>
<th colspan="2">Accounts</th>
<th colspan="2">Sign in to IMAP</th>
</tr>
</thead>
<tbody>
<tr><td id="accounts"></td>
	<td>
    	<p><a href="#login-google" class="little-btn">Sign in with Google</a></p>
        <p><a href="#login-yahoo" class="little-btn">Sign in with Yahoo!</a></p>
        <p><a href="#login-facebook" class="little-btn">Sign in with Facebook</a></p>
        <p><a href="#login-twitter" class="little-btn">Sign in with Twitter</a></p>
        <p><a href="#login-linkedin" class="little-btn">Sign in with LinkedIn</a></p>
        <p><a href="#login-other" class="little-btn">Sign in with IMAP</a></p>
        <iframe width="0" height="0" id="google-load"></iframe></td>
	<td>
        <table>
        <tbody>
        <tr>
        <td>Email address</td>
        <td><input name="email" type="text" id="email" /></td>
        </tr>
        <tr>
        <td>Password</td>
        <td><input name="password" type="password" id="pass" /></td>
        </tr>
        <tr>
        <td colspan="2"><a href="#login-submit" class="intro-btn">Sign in</a></td>
        </tbody>
        </table>
	</td>
</tr>
</tbody>
</table>

</div>
