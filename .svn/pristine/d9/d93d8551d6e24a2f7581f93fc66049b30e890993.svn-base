// JavaScript Document

var clientId = '61143827920-ok9rpqcq25phtggfrhaogkmlm8sed83d.apps.googleusercontent.com';
var scopes = 'https://mail.google.com/ https://www.google.com/m8/feeds https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/calendar';
var googleContacts = null;

// Is there an easier way to do this?
//   jsonp doesn't work because we can't read the hash from the response script
function doGoogleLogin(immediate, state) 
{
	if(typeof immediate == 'undefined')
		immediate = false;
	if(typeof state == 'undefined')
		state = 'getGoogleUser';
	else
	{
		// set up callback to call getGoogleUser first then call callback
		var callback = state;
		state = 'fumail_' + CryptoJS.lib.WordArray.random(16);
		window[state] = function (params) {
			try {
				// pass in callback to do this after we get user information
				getGoogleUser(params, callback);
			}
			catch (e)
			{
				if(console)
					console.log(e);
			}
			window[state] = null;
		};
	}
	
	// request new google token
	// try a get first
	var token_request = 'https://accounts.google.com/o/oauth2/auth' + 
		'?redirect_uri=https://fumail.me' + (immediate ? '/google.php' : '') + 
		'&approval_prompt=auto' +
		'&client_id=' + clientId +
		(immediate ? '&immediate=true' : '') + 
		'&response_type=token' +
		'&state=' + state +
		'&scope=' + scopes;
	if(immediate)
	{
		var googleFrame = $('#google-load');
		if(googleFrame.length == 0)
			$('<iframe width="0" height="0" id="#google-load" src="' + token_request + '"></iframe>').appendTo('#login');
		else
			googleFrame.attr('src', token_request);
	}
	else
		window.location = token_request;
};

function getGoogleSuccess(data, params, callback)
{
	if(console)
		console.log(data);
	var account = {
			user: data.email, 
			access: params['access_token'], 
			expires: new Date().getTime() + (parseInt(params['expires_in']) * 1000)
		};
	
	if(typeof callback == 'undefined')
		window.location.hash = '#mail';
	// do this after user info is loaded
	// store the accounts for the session
	else if(typeof callback == 'string' &&
		typeof window[callback] != 'undefined')
		window[callback].call(this, account);
	else
		callback.call(this, account);
		
}

function loadGoogleContacts(account)
{
	// load contacts inside a worker
	workQueue({type: 'google', request: account, result: getContactsSuccess});
}

function sortContacts(a, b)
{
	var aTitle = $(a).find('title').text(),
		aSort = aTitle != '' ? aTitle : $(a).find('gd\\:email').first().attr('address'),
		bTitle = $(b).find('title').text(),
		bSort = bTitle != '' ? bTitle : $(b).find('gd\\:email').first().attr('address');
	return aSort.toLowerCase().localeCompare(bSort.toLowerCase());
}

function getContactsSuccess(response)
{
	for(var i in response)
	{
		var contacts = $('#contacts'),
			contact = contacts.find('a[href="#' + response[i].id + '"]');
		if(contact.length > 0)
			return;
		contact = $('<li><a href="#' + id + '">' + (title != '' ? title : email) + '</a></li>');
		// sort just the new element
		var hit = false;
		contacts.find('li').each(function () {
			if($(this).text().toLowerCase().localeCompare(contact.text().toLowerCase()) > 0)
			{
				contact.insertBefore($(this));
				hit = true;
				return false;
			}
		});
		if(!hit)
			contacts.append(contact);
	}
}

function getGoogleUser(params, callback)
{
	// try to request username
	$.get('https://www.googleapis.com/oauth2/v1/userinfo', {
		'alt' : 'json',
		'access_token' : params['access_token']
	}, function (data) {
		getGoogleSuccess(data, params, callback);
	});
}
